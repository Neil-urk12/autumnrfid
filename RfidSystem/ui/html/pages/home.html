<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- <script src="https://unpkg.com/htmx.org@2.0.4"></script>
    <script src="https://unpkg.com/htmx.org/dist/ext/sse.js"></script>
    <script src="https://unpkg.com/htmx.org/dist/ext/json-enc.js"></script>
    <script src="https://unpkg.com/htmx-ext-sse@2.2.2"></script> -->
    <script src="ui/static/htmx.min.js"></script>
    <script src="ui/static/sse.js.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <title>RFID</title>
    <link rel="stylesheet" href="/ui/static/styles.css" />
</head>

<body>

    <div class="navbar" id="main-navbar" style="display: none;">
        <button hx-get="/student-partial" hx-target="#main" hx-swap="innerHTML" class="rfid">RFID</button>
        <button hx-get="/grades" hx-target="#main" hx-swap="innerHTML" class="rfid">Grades</button>
        <button hx-get="/bills" hx-target="#main" hx-swap="innerHTML" class="rfid">Bills</button>
    </div>

    </div>

    <main id="main" hx-ext="sse" sse-connect="/stream" sse-swap="studentcallback">

        <div class="container-home" id="student-data-container">

            <div id="welcome-section" class="welcome-wrapper">
                <div class="welcome-content">
                    <h1>Welcome to RFID</h1>
                    <p>Please scan your RFID card to view your student information.</p>
                    <i class="scan-icon fas fa-qrcode"></i>
                </div>
            </div>

            <div id="alternating-messages" class="message-wrapper">
                <div class="message-content">
                    <p class="message-item">View your current semester grades and academic progress</p>
                    <p class="message-item">Check your class schedule and room assignments</p>
                    <p class="message-item">Monitor your attendance and participation records</p>
                    <p class="message-item">Access your tuition balance and payment deadlines</p>
                    <p class="message-item">Stay updated with school announcements and events</p>
                    <p class="message-item">Track your academic requirements and prerequisites</p>
                </div>
            </div>

        </div>


    </main>
    <!-- <p hx-ext="sse" sse-connect="/stream" sse-swap="ping" style="display: none;">Ping</p> -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const messages = document.querySelectorAll('.message-item')
            let currentIndex = 0

            function showNextMessage() {
                messages.forEach(msg => msg.classList.remove('active'))
                messages[currentIndex].classList.add('active')
                currentIndex = (currentIndex + 1) % messages.length
            }

            showNextMessage()
            setInterval(showNextMessage, 4000)

            // Add SSE ping logging
            const sseSource = new EventSource('/stream')

            sseSource.addEventListener('ping', function (e) {
                console.log('SSE Ping received:', JSON.parse(e.data))
            })

            // Store student ID when received
            let currentStudentId = '';

            document.body.addEventListener('htmx:afterSwap', function (event) {
                console.log('Event:', event);
                console.log('Event Detail:', event.detail);
                if (!event || !event.detail) {
                    console.log('Event or event.detail is undefined');
                    return;
                }

                const navbar = document.getElementById('main-navbar');

                // Check if we can find the student ID
                const studentIdElement = document.getElementById('current-student-id');
                if (studentIdElement && studentIdElement.value) {
                    const currentStudentId = studentIdElement.value;
                    console.log('Current student ID:', currentStudentId);

                    // Update RFID Button (uses path parameter)
                    const rfidButton = navbar.querySelector('button[hx-get^="/student-partial"]');
                    if (rfidButton) {
                        rfidButton.setAttribute('hx-get', `/student-partial/${currentStudentId}`);
                        console.log('Updated RFID button hx-get:', rfidButton.getAttribute('hx-get'));
                        htmx.process(rfidButton); // Tell HTMX to recognize the change
                    }

                    // Update Grades Button (uses query parameter)
                    const gradesButton = navbar.querySelector('button[hx-get^="/grades"]');
                    if (gradesButton) {
                        gradesButton.setAttribute('hx-get', `/grades?student-id=${currentStudentId}`);
                        console.log('Updated Grades button hx-get:', gradesButton.getAttribute('hx-get'));
                        htmx.process(gradesButton); // Tell HTMX to recognize the change
                    }

                    // Update Bills Button (uses query parameter)
                    const billsButton = navbar.querySelector('button[hx-get^="/bills"]');
                    if (billsButton) {
                        billsButton.setAttribute('hx-get', `/bills?student-id=${currentStudentId}`);
                        console.log('Updated Bills button hx-get:', billsButton.getAttribute('hx-get'));
                        htmx.process(billsButton); // Tell HTMX to recognize the change
                    }
                } else {
                    console.log('Current student ID element not found or has no value in this swap.');
                    // Optional: Consider resetting button URLs if the student info partial is removed.
                }

                // Handle navbar visibility
                if (navbar) {
                    const requestPath = event.detail.pathInfo ? event.detail.pathInfo.requestPath : null;
                    console.log("Request Path: " + requestPath)
                    if (requestPath) {
                        const showNav = requestPath.startsWith('/student-partial/') ||
                            requestPath === '/grades' ||
                            requestPath === '/bills';

                        const hideNav = requestPath === '/error' || requestPath === '/';

                        navbar.style.display = showNav ? 'flex' : (hideNav ? 'none' : navbar.style.display);
                    }
                }
            });

            sseSource.addEventListener('connected', function (e) {
                console.log('SSE Connected:', JSON.parse(e.data))
            })

            sseSource.onerror = function (e) {
                console.error('SSE Error:', e)
            }
        })
    </script>

</body>

</html>
