<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>
    <script src="https://unpkg.com/htmx.org/dist/ext/sse.js"></script>
    <script src="https://unpkg.com/htmx.org/dist/ext/json-enc.js"></script>
    <script src="https://unpkg.com/htmx-ext-sse@2.2.2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <title>RFID</title>
    <link rel="stylesheet" href="/ui/static/styles.css" />
</head>

<body>

    <div class="navbar" id="main-navbar" style="display: none;">
        <button hx-get="/" hx-target="#main" hx-swap="innerHTML" class="rfid">RFID</button>
        <button hx-get="/test-grades" hx-target="#main" hx-swap="innerHTML" class="rfid">Grades</button>
        <!-- <button hx-get="/bills?student-id=${studentId}" hx-target="#main" hx-swap="innerHTML" class="rfid">Bills</button> -->
        <button hx-get="/bills?student-id=ACLC-2023-001" hx-target="#main" hx-swap="innerHTML"
            class="rfid">Bills</button>
    </div>

    </div>

    <main id="main">

        <div class="container-home" id="student-data-container" hx-ext="sse" sse-connect="/stream"
            sse-swap="studentcallback" hx-target=".container-home">

            <div id="welcome-section" class="welcome-wrapper">
                <div class="welcome-content">
                    <h1>Welcome to RFID</h1>
                    <p>Please scan your RFID card to view your student information.</p>
                    <i class="scan-icon fas fa-qrcode"></i>
                </div>
            </div>

            <div id="alternating-messages" class="message-wrapper">
                <div class="message-content">
                    <p class="message-item">View your current semester grades and academic progress</p>
                    <p class="message-item">Check your class schedule and room assignments</p>
                    <p class="message-item">Monitor your attendance and participation records</p>
                    <p class="message-item">Access your tuition balance and payment deadlines</p>
                    <p class="message-item">Stay updated with school announcements and events</p>
                    <p class="message-item">Track your academic requirements and prerequisites</p>
                </div>
            </div>

        </div>
        <p hx-ext="sse" sse-connect="/stream" sse-swap="ping" style="display: none;">Ping</p>

    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const messages = document.querySelectorAll('.message-item')
            let currentIndex = 0

            function showNextMessage() {
                messages.forEach(msg => msg.classList.remove('active'))
                messages[currentIndex].classList.add('active')
                currentIndex = (currentIndex + 1) % messages.length
            }

            showNextMessage()
            setInterval(showNextMessage, 4000)

            // Add SSE ping logging
            const sseSource = new EventSource('/stream')

            sseSource.addEventListener('ping', function (e) {
                console.log('SSE Ping received:', JSON.parse(e.data))
            })

            // Store student ID when received
            let currentStudentId = '';

            sseSource.addEventListener('studentcallback', function (e) {
                const data = JSON.parse(e.data);
                if (data.student && data.student.StudentID) {
                    currentStudentId = data.student.StudentID;
                    // Update bills button href with current student ID
                    const billsButton = document.querySelector('button[hx-get^="/bills"]');
                    if (billsButton) {
                        billsButton.setAttribute('hx-get', `/bills?student-id=${currentStudentId}`);
                    }
                }
            });

            sseSource.addEventListener('connected', function (e) {
                console.log('SSE Connected:', JSON.parse(e.data))
            })

            sseSource.onerror = function (e) {
                console.error('SSE Error:', e)
            }

            // HTMX event listener to control navbar visibility
            document.body.addEventListener('htmx:afterSwap', function (event) {
                const navbar = document.getElementById('main-navbar');
                const target = event.detail.target;
                const requestPath = event.detail.pathInfo ? event.detail.pathInfo.requestPath : null;

                // Ensure the swap happened in the correct container and we have a navbar element
                if (target && target.id === 'student-data-container' && navbar && requestPath) {

                    // Determine if the navbar should be shown based on the requested path
                    const showNav = requestPath.startsWith('/student-partial/') ||
                        requestPath === '/grades' ||
                        requestPath === '/bills';

                    // Determine if the navbar should be hidden (error or home page)
                    const hideNav = requestPath === '/error' || requestPath === '/';

                    if (showNav) {
                        navbar.style.display = 'flex'; // Or 'block', depending on your CSS
                    } else if (hideNav) {
                        navbar.style.display = 'none';
                    }
                    // Optional: Handle cases where the path doesn't match known patterns,
                    // potentially leaving the navbar state unchanged or hiding it by default.
                    // else {
                    //     navbar.style.display = 'none'; // Default to hidden if path is unknown
                    // }
                } else if (target && target.id === 'student-data-container' && navbar && requestPath === '/') {
                    // Explicitly hide if the RFID button (hx-get="/") was clicked, resetting to welcome
                    // This case might be redundant due to the hideNav check above, but kept for clarity.
                    navbar.style.display = 'none';
                }
            });
        })
    </script>

</body>

</html>
